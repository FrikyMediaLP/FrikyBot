<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>NewsMaker - FrikyBot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- GENERAL CSS -->
    <link href="../../styles/standard.css" rel="stylesheet">
    <link href="../../styles/Grid/Grid_Foundation.css" rel="stylesheet">

    <!-- PAGE CSS-->
    <link href="../../styles/Grid/Grid_Default.css" rel="stylesheet">

    <!-- GENERAL JS-->
    <script src="../../scripts/standard.js"></script>

    <!-- MISC -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">

    <script src="../misc/NavigationV2/NavigationV2.js"></script>
    <link href="../misc/NavigationV2/NavigationV2.css" rel="stylesheet">

    <script src="../misc/OUTPUT/OUTPUT.js"></script>
    <link href="../misc/OUTPUT/OUTPUT.css" rel="stylesheet">

    <script src="../misc/BOT_STATUS/BOT_STATUS.js"></script>
    <link href="../misc/BOT_STATUS/BOT_STATUS.css" rel="stylesheet">

    <script src="../misc/Login/Login.js"></script>
    <link href="../misc/Login/Login.css" rel="stylesheet">

    <script src="../News/News_scripts"></script>
    <link href="../News/News_styles" rel="stylesheet">

    <script src="../misc/SwitchButton/SwitchButton.js"></script>
    <link href="../misc/SwitchButton/SwitchButton.css" rel="stylesheet">

    <style>
        .darkmode #grid #content {
            background-color: #292929 !important;
            color: white;
        }
    </style>

</head>
<body onload="Standard_Page_Init(); init();">
    <!-- MAIN GRID -->
    <div id="grid">
        <!-- NAVI HEADER -->
        <div class="cellM" id="naviHeader">
            <a href="../../">FRIKY<span>BOT</span></a>
        </div>

        <!-- CONTENT HEADER -->
        <div class="cellM" id="contentHeader">

        </div>

        <!-- NAVI -->
        <div class="cellM" id="navi">
            <div id="BOT_STATUS_DETAILS_MINI">

            </div>
            <div id="mainNavi">

            </div>
            <button id="LightModeButton" onclick="toggleLightMode()">DarkMode</button>
            <div id="license"> - <a href="https://fontawesome.com/license" target="_blank">Icon license</a> - </div>
        </div>

        <!-- ACTUAL CONTENT -->
        <div class="cellM" id="content" style="background-color: #f5f5f5;">

            <script>
                const NEWS_FEED_NEWSMAKER_ELEMENTS = {
                    title_id: 'Editor_Input_Title',
                    data_id: 'Editor_Input_Date',
                    page_id: 'Editor_Input_Page',
                    top_id: 'Editor_Input_Description_Top',
                    bottom_id: 'Editor_Input_Description_Bottom',
                    image_class: 'NEWS_FEED_NEWSMAKER_IMAGE',
                    misc_class: 'NEWS_FEED_NEWSMAKER_MISC'
                };

                function init() {
                    OUTPUT_create();
                    Bot_Status_Details_Settings.ErrorOutput = OUTPUT_showError;

                    fetch(NEWS_FEED_SETTINGS.ROOT_URL + "/access", getAuthHeader())
                        .then(STANDARD_FETCH_RESPONSE_CHECKER)
                        .then(json => {
                            if (json.err) return Promise.reject(new Error(json.err));
                            document.getElementById('NEWS_FEED_NewsMaker').style.display = "grid";

                            Check_Query();
                        })
                        .catch(err => {
                            console.log(err);
                            OUTPUT_showError('ACCESS DENIED');
                        });
                }

                function Check_Query() {
                    if (GetURLSearchArray().length < 1) {
                        NEWS_FEED_NEWSMAKER_fill({});
                        document.getElementById('SaveBTN').disabled = true;
                        return;
                    }

                    let query = GetURLSearchArray()[0].name + "=" + GetURLSearchArray()[0].value[0];

                    fetch(NEWS_FEED_SETTINGS.ROOT_URL + '?' + query, getAuthHeader())
                        .then(STANDARD_FETCH_RESPONSE_CHECKER)
                        .then(json => {
                            if (json.err) return Promise.reject(new Error(json.err));
                            NEWS_FEED_NEWSMAKER_fill(json.data.News[0]);
                            NEWS_FEED_NEWSMAKER_updatePreview();
                            document.getElementById('SaveBTN').disabled = true;
                        })
                        .catch(err => {
                            console.log(err);
                        });
                }

                function NEWS_FEED_NEWSMAKER_updatePreview() {
                    let json = NEWS_FEED_NEWSMAKER_generateJSON();
                    document.getElementById("NEWS_FEED_FullPage").innerHTML = NEWS_FEED_createFullPage(json);
                    if (document.getElementById("NEWS_FEED_FullPage").innerHTML) document.getElementById('SaveBTN').disabled = false;
                    else document.getElementById('SaveBTN').disabled = true;
                }
                function NEWS_FEED_NEWSMAKER_generateJSON() {
                    //Collect Data
                    let preview = {
                        title: document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.title_id).value,
                        description: {
                            top: [],
                            bottom: []
                        },
                        images: [],
                        misc: [],
                        date: new Date(document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.data_id).value).getTime(),
                        page: toURLFriendlyText(document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.page_id).value || document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.title_id).value)
                    };

                    //Add Top Paragraphs
                    for (let p of document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.top_id).value.split("\n")) {
                        if (p.indexOf("#") == 0) {
                            preview.description.top.push({ text: p.substring(1), isHeadline: true });
                        } else if (p.length > 0) {
                            preview.description.top.push(p);
                        }
                    }

                    //Add Bottom Paragraphs
                    for (let p of document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.bottom_id).value.split("\n")) {
                        if (p.indexOf("#") == 0) {
                            preview.description.bottom.push({ text: p.substring(1), isHeadline: true });
                        } else if (p.length > 0) {
                            preview.description.bottom.push(p);
                        }
                    }

                    //Add Images
                    for (let img of document.getElementsByClassName(NEWS_FEED_NEWSMAKER_ELEMENTS.image_class)) {
                        let img_json = {
                            source: img.childNodes[1].childNodes[0].value ? img.childNodes[1].childNodes[0].value : "",
                            title: img.childNodes[1].childNodes[1].value ? img.childNodes[1].childNodes[1].value : "",
                            link: img.childNodes[1].childNodes[3].value ? img.childNodes[1].childNodes[3].value : "",
                            target: img.childNodes[1].childNodes[4].value ? img.childNodes[1].childNodes[4].value : ""
                        };
                        preview.images.push(img_json);
                    }

                    //Add Misc
                    for (let misc of document.getElementsByClassName(NEWS_FEED_NEWSMAKER_ELEMENTS.misc_class)) {
                        let misc_json = {
                            text: misc.childNodes[1].childNodes[0].value ? misc.childNodes[1].childNodes[0].value : "",
                            icon: misc.childNodes[1].childNodes[1].value ? misc.childNodes[1].childNodes[1].value : "",
                            type: misc.childNodes[1].childNodes[3].childNodes[0].value ? misc.childNodes[1].childNodes[3].childNodes[0].value : ""
                        };

                        if (misc_json.type == "link") {
                            misc_json.link = misc.childNodes[1].childNodes[3].childNodes[1].value ? misc.childNodes[1].childNodes[3].childNodes[1].value : "";
                            misc_json.target = misc.childNodes[1].childNodes[3].childNodes[2].value ? misc.childNodes[1].childNodes[3].childNodes[2].value : "";
                        } else if (misc_json.type == "color") {
                            misc_json.type = misc.childNodes[1].childNodes[3].childNodes[1].value ? misc.childNodes[1].childNodes[3].childNodes[1].value : "";
                        } else if (misc_json.type == "size") {
                            misc_json.type = misc.childNodes[1].childNodes[3].childNodes[1].value ? misc.childNodes[1].childNodes[3].childNodes[1].value : "";
                        }
                        preview.misc.push(misc_json);
                    }

                    //Return Data
                    return preview;
                }
                function NEWS_FEED_NEWSMAKER_fill(news) {
                    if (!news) return;
                    document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.title_id).value = news.title || '';
                    let date = new Date(news.date || Date.now());

                    let year = date.getFullYear();
                    if (year < 10) year = "0" + year;

                    let month = date.getMonth();
                    if (month < 10) month = "0" + month;

                    let dt = date.getDate();
                    if (dt < 10) dt = "0" + dt;

                    let min = date.getHours();
                    if (min < 10) min = "0" + min;

                    let sec = date.getMinutes();
                    if (sec < 10) sec = "0" + sec;

                    document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.data_id).value = year + "-" + month + "-" + dt + "T" + min + ":" + sec;
                    document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.page_id).value = news.page || '';

                    //Add Top Paragraphs
                    let s = '';
                    for (let p of (news.description || {}).top || []) {
                        if (p instanceof Object) {
                            s += '#' + p.text;
                        } else {
                            s += p;
                        }
                        s += '\n';
                    }
                    document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.top_id).value = s;

                    //Add bottom Paragraphs
                    s = '';
                    for (let p of (news.description || {}).bottom || []) {
                        if (p instanceof Object) {
                            s += '#' + p.text;
                        } else {
                            s += p;
                        }
                        s += '\n';
                    }
                    document.getElementById(NEWS_FEED_NEWSMAKER_ELEMENTS.bottom_id).value = s;

                    //Add Images
                    for (let img of news.images || []) {
                        NEWS_FEED_NEWSMAKER_ADD_IMAGE(img);
                    }

                    //Add Misc
                    for (let misc of news.misc || []) {
                        NEWS_FEED_NEWSMAKER_ADD_MISC(misc);
                    }

                    //Update Preview
                    NEWS_FEED_NEWSMAKER_updatePreview();
                }

                function NEWS_FEED_NEWSMAKER_ADD_IMAGE(data = {}) {
                    let s = '<center>' + (document.getElementsByClassName(NEWS_FEED_NEWSMAKER_ELEMENTS.image_class).length + 1) + '</center>';
                    s += '<div>';
                    s += '<input placeholder="Source here" value="' + (data.source || "") + '"/>';
                    s += '<input placeholder="Title here" value="' + (data.title || "") + '"/>';
                    s += '<br />';
                    s += '<input placeholder="Link here" value="' + (data.link || "") + '"/>';

                    const types = ['_blank', '_self', '_parent', '_top'];
                    s += '<select>';
                    for (let typ of types) {
                        s += '<option value="' + typ + '" ' + (data.target === typ ? 'selected' : '') + '>' + typ + '</option>';
                    }

                    s += '</select>';
                    s += '</div>';

                    let elt = document.createElement("div");
                    elt.classList.add("Element");
                    elt.classList.add(NEWS_FEED_NEWSMAKER_ELEMENTS.image_class);
                    elt.id = 'Image_' + (document.getElementsByClassName(NEWS_FEED_NEWSMAKER_ELEMENTS.image_class).length + 1);
                    elt.setAttribute("draggable", "true");
                    elt.setAttribute("ondragover", "NEWS_FEED_NEWSMAKER_allowDrop(event)");
                    elt.setAttribute("ondragstart", "NEWS_FEED_NEWSMAKER_drag(event)");
                    elt.setAttribute("ondrop", "NEWS_FEED_NEWSMAKER_dropSwap(event)");
                    elt.innerHTML = s;
                    document.getElementById("Image_List").append(elt);
                }

                function NEWS_FEED_NEWSMAKER_ADD_MISC(data = {}) {
                    let s = '<center>' + (document.getElementsByClassName(NEWS_FEED_NEWSMAKER_ELEMENTS.misc_class).length + 1) + '</center>';
                    s += '<div>';
                    s += '<input placeholder="Text here" value="' + (data.text || "") + '"/>';
                    s += '<input placeholder="Icon Source here" value="' + (data.icon || 'images/icons/paperclip-solid.svg') + '"/>';
                    s += '<br />';
                    s += '<div>';
                    s += NEWS_FEED_NEWSMAKER_MISC_create_select(data.type);
                    s += NEWS_FEED_NEWSMAKER_MISC_create_content(data.type, data);
                    s += '</div>';
                    s += '</div>';

                    let elt = document.createElement("div");
                    elt.classList.add("Element");
                    elt.classList.add(NEWS_FEED_NEWSMAKER_ELEMENTS.misc_class);
                    elt.id = 'Misc_' + (document.getElementsByClassName(NEWS_FEED_NEWSMAKER_ELEMENTS.misc_class).length + 1);
                    elt.setAttribute("draggable", "true");
                    elt.setAttribute("ondragover", "NEWS_FEED_NEWSMAKER_allowDrop(event)");
                    elt.setAttribute("ondragstart", "NEWS_FEED_NEWSMAKER_drag(event)");
                    elt.setAttribute("ondrop", "NEWS_FEED_NEWSMAKER_dropSwap(event)");
                    elt.innerHTML = s;
                    document.getElementById("Misc_List").append(elt);
                }
                function NEWS_FEED_NEWSMAKER_MISC_Change(x) {
                    x.parentElement.innerHTML = NEWS_FEED_NEWSMAKER_MISC_create_select(x.value) + NEWS_FEED_NEWSMAKER_MISC_create_content(x.value);
                }
                function NEWS_FEED_NEWSMAKER_MISC_create_select(selected) {
                    let s = "";
                    const types = ['info', 'link', 'color', 'size'];
                    s += '<select oninput="NEWS_FEED_NEWSMAKER_MISC_Change(this)">';
                    for (let typ of types) {
                        s += '<option value="' + typ + '" ' + (selected === typ ? 'selected' : '') + '>' + typ + '</option>';
                    }
                    s += '</select>';
                    return s;
                }
                function NEWS_FEED_NEWSMAKER_MISC_create_content(type, data = {}) {
                    let content = "";
                    if (type == "link") {
                        content = '<input type="text" placeholder="link in here" value="' + (data.link || '') + '"/>';

                        const types = ['_blank', '_self', '_parent', '_top'];
                        content += '<select>';
                        for (let typ of types) {
                            content += '<option value="' + typ + '" ' + (data.target === typ ? 'selected' : '') + '>' + typ + '</option>';
                        }
                        content += '</select>';
                    } else if (type == "color") {
                        content = '<input type="text" placeholder="color here!" />';
                    } else if (type == "size") {
                        content = '<input type="text" placeholder="size here! (px and em only)" />';
                    }
                    return content;
                }

                function NEWS_FEED_NEWSMAKER_save() {
                    let options = getAuthHeader();
                    options['method'] = GetURLSearchArray().length < 1 ? 'POST' : 'PUT';
                    options['headers']['Content-Type'] = 'application/json';
                    options['body'] = JSON.stringify(NEWS_FEED_NEWSMAKER_generateJSON());

                    fetch(NEWS_FEED_SETTINGS.ROOT_URL, options)
                        .then(STANDARD_FETCH_RESPONSE_CHECKER)
                        .then(json => {
                            OUTPUT_showInfo("News Saved!");
                            document.getElementById('SaveBTN').disabled = true;
                        })
                        .catch(err => {
                            OUTPUT_showError("Saving failed!");
                            console.log(err);
                        });
                }

                function NEWS_FEED_NEWSMAKER_allowDrop(event) {
                    event.preventDefault();
                }
                function NEWS_FEED_NEWSMAKER_drag(event) {
                    event.dataTransfer.setData("text", event.target.id);
                }
                function NEWS_FEED_NEWSMAKER_dropTrash(event) {
                    event.preventDefault();
                    let elt = document.getElementById(event.dataTransfer.getData("text"));
                    let elts = document.getElementsByClassName(elt.classList[1]);
                    let i = 0;

                    elt.remove();

                    for (let elte of elts) {
                        elte.id = elte.id.sub(0, elte.id.indexOf("_") + 1) + (++i);
                        elte.childNodes[0].innerHTML = i;
                    }
                }
                function NEWS_FEED_NEWSMAKER_dropSwap(event) {
                    event.preventDefault();
                    let elt1 = document.getElementById(event.dataTransfer.getData("text"));
                    let elt2 = event.srcElement;

                    if (!elt1 || !elt2) {
                        return;
                    }

                    do {
                        elt2 = elt2.parentElement;
                    } while (!elt2.classList.contains("Element"));

                    if (elt1.classList.value == elt2.classList.value && elt1 != elt2) {
                        //Swap ID
                        let temp = elt1.id;
                        elt1.id = elt2.id;
                        elt2.id = temp;

                        //Save Values
                        elt1 = elt1.childNodes[1];
                        elt2 = elt2.childNodes[1];

                        let values1 = [];
                        let values2 = [];

                        for (let v of elt1.childNodes) {
                            values1.push(v.value);
                        }
                        for (let v of elt2.childNodes) {
                            values2.push(v.value);
                        }

                        //SWAP
                        temp = elt1.innerHTML;
                        elt1.innerHTML = elt2.innerHTML;
                        elt2.innerHTML = temp;

                        for (let i = 0; i < elt2.childNodes.length && i < values1.length; i++) {
                            if (values1[i]) {
                                elt2.childNodes[i].value = values1[i];
                            }
                        }
                        for (let i = 0; i < elt1.childNodes.length && i < values2.length; i++) {
                            if (values2[i]) {
                                elt1.childNodes[i].value = values2[i];
                            }
                        }
                    }
                }

                function NEWS_FEED_NEWSMAKER_Title_Change(x) {
                    document.getElementById('Editor_Input_Page').placeholder = toURLFriendlyText(x.value) || 'URL-Friendly Title here';
                }
                function toURLFriendlyText(text) {
                    let friendly = "";
                    const allowed = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9"];
                    const conversions = {
                        'ä': 'ae',
                        'ü': 'ue',
                        'ö': 'oe',
                        ' ': '-'
                    };

                    for (let char of text.toLowerCase()) {
                        if (conversions[char] !== undefined) friendly += conversions[char];
                        if (allowed.find(elt => elt === char) !== undefined) friendly += char;
                    }

                    return friendly;
                }
            </script>

            <output></output>

            <div id="NEWS_FEED_NewsMaker">
                <div class="Editor">
                    <h1>NEWS MAKER <button id="SaveBTN" onclick="NEWS_FEED_NEWSMAKER_save()" disabled>SAVE</button></h1>
                    <div style="position: relative; height: 30px;">
                        <input id="Editor_Input_Date" type="datetime-local" onchange="NEWS_FEED_NEWSMAKER_updatePreview()" />
                    </div>
                    <input id="Editor_Input_Title" placeholder="Title here" oninput="NEWS_FEED_NEWSMAKER_updatePreview(); NEWS_FEED_NEWSMAKER_Title_Change(this);" />
                    <br />
                    <textarea id="Editor_Input_Description_Top" placeholder="Top Description here: # -> Headline" oninput="NEWS_FEED_NEWSMAKER_updatePreview()"></textarea><br />
                    <textarea id="Editor_Input_Description_Bottom" placeholder="Bottom Description here: # -> Headline" oninput="NEWS_FEED_NEWSMAKER_updatePreview()"></textarea><br />
                    <input id="Editor_Input_Page" placeholder="URL-Friendly Title here" oninput="NEWS_FEED_NEWSMAKER_updatePreview();" /><br />

                    <div>
                        <div class="List">
                            <h4>Images</h4>
                            <button style="grid-area: bt0; background-color: lime; width: 100%; font-size: 15px;" title="Update Images" onclick="NEWS_FEED_NEWSMAKER_updatePreview()">UPDATE</button>
                            <div class="TrashElement" title="Remove Image" ondragover="NEWS_FEED_NEWSMAKER_allowDrop(event)" ondrop="NEWS_FEED_NEWSMAKER_dropTrash(event)"><img src="../images/icons/trash-alt-solid.svg" /></div>
                            <button style="grid-area: bt2;" title="Add Image" onclick="NEWS_FEED_NEWSMAKER_ADD_IMAGE()">+</button>
                            <div id="Image_List">

                            </div>
                        </div>
                        <div class="List" style="grid-area: list;">
                            <h4>Misc</h4>
                            <button style="grid-area: bt0; background-color: lime; width: 100%; font-size: 15px;" title="Update Images" onclick="NEWS_FEED_NEWSMAKER_updatePreview()">UPDATE</button>
                            <div class="TrashElement" title="Remove Misc" ondragover="NEWS_FEED_NEWSMAKER_allowDrop(event)" ondrop="NEWS_FEED_NEWSMAKER_dropTrash(event)"><img src="../images/icons/trash-alt-solid.svg" /></div>
                            <button style="grid-area: bt2;" title="Add Misc" onclick="NEWS_FEED_NEWSMAKER_ADD_MISC()">+</button>
                            <div id="Misc_List">

                            </div>
                        </div>
                    </div>
                </div>
                <div id="NEWS_FEED_FullPage">

                </div>
            </div>
        </div>
    </div>
</body>
</html>