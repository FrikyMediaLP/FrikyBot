<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Alerts - FrikyBot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- GENERAL CSS -->
    <link href="/Alerts/standard.css" rel="stylesheet">
    <link href="/styles/standard.css" rel="stylesheet">

    <!-- PAGE CSS-->
    <style>
        body {
            background-color: #ff00ff;
            overflow: hidden;
        }

        #ALERT {
            width: calc(100% - 100px);
            height: calc(100% - 100px);
            padding: 50px;
            position: relative;
        }
    </style>

    <!-- GENERAL JS-->
    <script src="/Alerts/standard.js"></script>
    <script src="/scripts/standard.js"></script>

    <!-- PAGE JS-->
    <script>
        let selected_topics = window.location.pathname.split('/').slice(4).join(',');
        if (selected_topics === '') selected_topics = 'alerts';

        const register_info = {
            origin: "/Alerts/Overlay",
            topic: "Alerts",
            misc: selected_topics
        };

        let CONFIG = {};
        let EVENT_PIPELINE = [];
        let socket = {};

        function init() {
            socket = StartWebsocket(register_info);

            socket.addEventListener('message', function (event) {
                let type = event.data.toString().split(":")[0];
                if (type === 'register' || type === 'Error') return;
                let data = JSON.parse(event.data.toString().split(":").slice(1).join(":"));

                if (type === 'settings') {
                    CONFIG = data;
                } else {
                    //Add to Pipeline
                    if (EVENT_PIPELINE.length === 0) List_triggerAlert(type, data);
                    EVENT_PIPELINE.push({ type, data });
                }

                //Echo back (Ping-Pong alternative)
                socket.send(event.data.toString());
            });
        }
        
        function List_triggerAlert(type, alert = {}) {
            //Add Config Settings
            let cfg = cloneJSON(CONFIG['Alerts'][type]);
            
            cfg.message = FillFormattedString(cfg.message, alert);
            if (cfg.tts) {
                cfg.tts = alert.message;                    //Type specific Message
                cfg.tts_volume = cfg.tts_volume / 100;
                cfg.tts_pitch = CONFIG.TTS_PITCH;
                cfg.tts_voice = CONFIG.PREVIEW_VOICE;
            }

            document.getElementById("ALERT").innerHTML = createAlertHTML(type, cfg, 'MAIN', List_triggerNext);
            triggerAlert('MAIN', cfg, List_triggerNext);
        }
        function List_triggerNext() {
            EVENT_PIPELINE = EVENT_PIPELINE.slice(1);
            if (EVENT_PIPELINE.length === 0) return;

            let event = EVENT_PIPELINE[0];
            List_triggerAlert(event.type, event.data);
        }
    </script>

    <!-- MISC -->
    <script src="/misc/SwitchButton/SwitchButton.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
</head>
<body onload="init();">
    <!-- MAIN GRID -->
    <div id="ALERT">

    </div>
</body>
</html>